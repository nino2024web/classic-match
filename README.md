# 要件定義書：作品中心・匿名コミュニティ型「Next.js/React TypeScript アプリ」

* 文書版数: v1.1
* 作成日: 2025-10-09
* 想定技術: Next.js 14+（App Router, RSC/Server Actions）/ React 18 / TypeScript 5 / PostgreSQL 15+（pgvector）/ Prisma / Redis / WebSocket（Socket.IO or ws／Pusher／Ably）/ tRPC または Next API Routes / Auth.js（NextAuth.js）
* 対象プラットフォーム: Web（PWA想定）、将来 iOS/Android ラッパー

---

## 1. 概要

**目的**: 人ではなく「音楽作品」を主語に、作品理解と発見、短文メモ、匿名対話を促す。著作権・規約のリスクを避けつつ、濃い鑑賞体験を提供する。
**コンセプト**: 「今日はバッハとだけ付き合う」。作品との一対一の関係に没頭できる場。
**成功指標（KGI）**: 継続的な記述と回遊が生まれ、匿名でも安全で健全なコミュニティが維持されること。

**スコープ（MVP）**:

1. 作品メタデータ＋作品ページ（概要/聴きどころ/外部導線/匿名メモ）
2. 作曲家ページ（前書き・目次・年表）
3. 感情タグと近縁レコメンド
4. 作者ラウンジ（全体スレ＋スローモード）
5. 認証（メール魔法リンク・パスワードレス + 任意 Passkey）

---

## 2. 用語定義

* **作品**: 楽曲単位（曲/楽章含む）。
* **作曲家**: 作品の作者。系譜情報を持つ。
* **メタデータ**: 時代/形式/調性/編成/テンポ感/曲想タグ/聴きどころ/参考解説 等。
* **感情タグ**: ユーザーの主観語彙（例: 透明/厳粛/祈り）。
* **共鳴スタンプ**: 「いいね」に代わる反応。語彙アイコン（例: 透明感/畏怖）。
* **匿名メモ**: 作品ページに付与する短文（公開/非公開切替）。
* **ラウンジ**: 作者（作曲家）単位の全体スレッド群。
* **小部屋**: 4〜6人の期間限定チャット。

---

## 3. 利用者と権限

* **ゲスト**: 閲覧のみ。匿名メモ作成時にライト認証を促す。
* **登録ユーザー**: 匿名ペンネームでメモ投稿・スタンプ・小部屋参加申請が可能。
* **管理者**: メタデータ作成/編集、NGワード管理、通報審査、アカウント制御。
* **モデレーター（任意）**: 通報対応、仮非表示解除/維持判断。

---

## 4. 主要ユースケース

* U1: 気分（3語）から作品候補を得て、外部配信への導線で視聴する。
* U2: 再生中に**自動書記モード**（2〜3分タイマー）で感じた語を連打→保存。
* U3: 保存時に「結論一文を先頭に」自動リライトテンプレを提示。
* U4: 他者メモに**共鳴スタンプ**で反応。スタンプの集計が作品ページに可視化。
* U5: 作曲家ラウンジでテーマ別スレに投稿。スローモードで低刺激運用。
* U6: タグ類似・時代近接・感情埋め込みに基づく**近縁曲レコメンド**を受ける。
* U7: 小部屋（承認制/2週間）で深掘り。終了後は各自にログ保存。

---

## 5. 画面/フロー（MVP）

1. **オンボーディング**: ペンネーム → 同意（匿名ルール） → 初期感情タグ3つ。※スキップ常設。
2. **ホーム**: 今の気分（3語選択）/時代年表ナビ/作曲家相関図（簡易）。
3. **作曲家ページ**: 前書き（3行）/目次（代表作・ジャンル索引）/年表・系譜/スタイル・曲想タグ/初心者向け3曲/あとがき。
4. **作品ページ**: 概要/聴きどころ3点/用語ミニ辞典/感情タグ/近縁曲/外部配信ボタン/匿名メモ欄/作品別スレ。
5. **ラウンジ**: 作者別スレッド、テンプレ投稿（「刺さった小節/理由一行/似てる曲一つ」）。
6. **小部屋**: 4〜6人、承認制、2週間自動クローズ、週課題テンプレを固定表示。

---

## 6. 機能要件（Functional Requirements）

### 6.1 メタデータ管理（管理者）

* F-ADMIN-001: 作曲家 CRUD（前書き/目次/年表/系譜/タグ/おすすめ3曲）。
* F-ADMIN-002: 作品 CRUD（時代/形式/調性/編成/テンポ感/曲想タグ/概要/聴きどころ/用語辞典参照）。
* F-ADMIN-003: 外部配信**導線テンプレ**管理（埋め込みはせずリンクのみ。曲IDは原則保存しない）。
* F-ADMIN-004: NGワード辞書・自動モデレータールールの管理。

### 6.2 作品・発見

* F-EXP-001: 「今の気分」3語選択から作品候補を表示（語彙→埋め込み→作品ベクトル近傍検索）。
* F-EXP-002: 作品ページに**近縁曲**（タグ類似/時代近接/和声近接スコアの合成）。
* F-EXP-003: 作曲家相関（影響関係）簡易グラフ。

### 6.3 記述体験

* F-NOTE-001: **自動書記モード**（2〜3分タイマー、句読点・文法不問、終了時に深呼吸ガイド表示）。
* F-NOTE-002: 保存時に**一文要約テンプレ**を提示（例: 「今日のこの曲は◯◯だから良い」）。
* F-NOTE-003: メモの公開/非公開切替。公開は**250字上限**。長文は非公開ノートへ。
* F-NOTE-004: **共鳴スタンプ**の押下と集計。作品・メモ単位で可視化。

### 6.4 コミュニティ

* F-COM-001: ラウンジ（全体スレ）：スレッド化、スローモード（30秒〜2分）、テンプレ投稿、NGワード自動拡張、通報→即時**仮非表示**。
* F-COM-002: 小部屋：4〜6人、**承認制**、**2週間**で自動クローズ、既読非表示オプション、ブロック/ミュート。
* F-COM-003: 個人チャット：**リクエスト制**、承認後開通。通話/外部連絡先はUIから分離し「自己責任宣言」のワンクッション。

### 6.5 認証・アカウント

* F-AUTH-001: **パスワードレス**（メール魔法リンク）を標準。Passkey/WebAuthn対応（任意）。
* F-AUTH-002: 段階認証：ゲスト閲覧 → 投稿時にライト認証 → 個チャ開放時のみ追加認証（Passkey/2FA）。
* F-AUTH-003: 匿名ペンネーム必須。メールは非公開。デバイス認証上限・ログイン履歴表示・ワンクリック全端末ログアウト。

### 6.6 モデレーション

* F-MOD-001: NGワード自動フィルタ、通報、仮非表示、ブロック/ミュート（1タップ）。
* F-MOD-002: レート制限、Bot 検知（不可視）。hCaptcha等は最終手段。

### 6.7 A/B テスト・計測

* F-AB-001: 文言・導線に限定した A/B テスト（例: 投稿プロンプト A/B）。
* F-ANL-001: 行動ログ（最小化）。ダッシュボードに主要KPIを表示。

---

## 7. 非機能要件（NFR）

* **セキュリティ**: OWASP ASVS L2、CSRF/RateLimit、強制ログアウト、権限境界の徹底。
* **プライバシー**: データ最小化（氏名/電話/位置は不要）。ユーザー再生リンクは**サーバに保存しない**（ローカル保存）。
* **可用性**: 99.9%（就業時間帯）。スローモードで書き込みバーストを抑制。
* **性能**: 作品一覧 < 200ms（p95）、検索 < 500ms（p95）。
* **アクセシビリティ**: WCAG 2.2 AA。キーボード操作/コントラスト/スクリーンリーダー対応。
* **国際化**: 日本語優先。将来の i18n を考慮したキー設計。
* **通知方針**: 低刺激。デイリー集約、緊急モデ通知のみ即時。

---

## 8. データ要件 / スキーマ（概要）

**RDB（PostgreSQL + pgvector + Prisma）**

* composers(id, name, era_range, intro, toc, timeline_json, lineage_json, style_tags[], recommended_work_ids[], outro)
* works(id, composer_id, title, form, key, instrumentation, tempo_feel, era, description, highlights[3], glossary_refs[], mood_tags[], vector_embedding VECTOR)
* tags(id, kind, label, synonyms[])
* work_tags(work_id, tag_id)
* recommendations(work_id, related_work_id, score, basis)
* user_profiles(user_id, penname, top_eras[], top_moods[], settings_json)
* notes(id, user_id, work_id, body, is_public, summary_one_liner, resonance_counts_json, created_at)
* lounge_threads(id, composer_id, topic, template_kind, slowmode_sec)
* lounge_posts(id, thread_id, user_id, body, resonance_counts_json, is_hidden_temp)
* rooms(id, topic, capacity, open_at, close_at, options_json)
* room_members(room_id, user_id, role)
* dm_threads(id, requester_id, accepter_id, opened_at)
* dm_messages(id, thread_id, sender_id, body, is_hidden_temp)
* reports(id, target_type, target_id, reason, status)
* ab_tests(id, key, variant, user_id)
* events(id, user_id, kind, payload_json, created_at)

**ローカル専用（サーバ保存禁止）**

* user_playback_links（作品別の個人再生リンク）。ブラウザ LocalStorage/IndexedDB のみ。

**保持・削除**

* 通報・モデ関連は90日保持。ユーザー削除時はノート/チャットの個人識別子を削除（匿名化）。

---

## 9. 外部連携・規約対応

* 音源は**外部配信リンク**のみ（YouTube/Spotify/Apple Music など）。埋め込みは規約を作品単位で確認可能なメモ欄に限定。
* 認証: Auth.js（NextAuth.js）メールマジックリンク + WebAuthn パスキー。
* メール配信: Resend/SendGrid。
* hCaptcha（最終手段）。

---

## 10. レコメンド要件（初期アルゴリズム）

* **タグ類似度**: Jaccard/TF-IDF コサイン。
* **時代近接**: 年代差分の距離関数。
* **和声近接（簡易）**: 調性・終止形・音度出現の共通度（管理者メタの軽量特徴）。
* **感情埋め込み**: ユーザー匿名メモの文埋め込み → 作品ベクトルに近傍探索（pgvector）。
* **合成スコア**: w1*タグ + w2*時代 + w3*和声 + w4*感情（重みは実験で最適化）。

---

## 11. 文言・世界観（例・MVP同梱）

* ログイン: 「開演する」 / ゲスト: 「見学する」
* 同意チェック: 「音に敬意、ひとに寛容、猫様に忠誠。」
* エラー: 「舞台袖で転びました（再試行）」/「猫様がケーブルをかじりました（時間を置いて再度）」
* 儀式は**常時スキップ可**。「演出をスキップ」を全画面で保証。

---

## 12. 計測/KPI

* 投稿完了率、共鳴スタンプ率、作品間回遊率、スレ滞在時間。
* 小部屋: 在室完走率、週課題達成数、再参加率。
* 品質: ブロック発生率の低さ、通報から仮非表示までの平均時間。
* A/B: プロンプト A/B の投稿率差、離脱ポイント（タイマー/保存/公開切替）。

---

## 13. 受け入れ基準（抜粋）

* AC-001: 作品ページに**外部配信ボタンのみ**が表示され、サーバDBに外部サービスの曲IDが保存されていないこと。
* AC-002: 自動書記モードが**指定時間で強制終了**し、保存ダイアログに**一文要約テンプレ**が毎回提示される。
* AC-003: 公開メモは**250字上限**で超過時に保存不可。
* AC-004: ラウンジはスローモード有効時、**投稿間隔を下回る投稿が拒否**される。
* AC-005: 通報後、対象投稿が**即時仮非表示**になり、モデ画面で復帰/維持が選択できる。
* AC-006: 近縁曲が**3件以上**提示され、スコアの根拠（タグ/時代 等）がUIで示される。
* AC-007: Passkey が登録・認証でき、**個チャ開通時のみ**追加認証を要求する。
* AC-008: ブロック設定で双方向不可視が成立し、既読表示はユーザー設定で OFF にできる。
* AC-009: ユーザー再生リンクが**ローカルのみ**に保存され、別端末からは参照不可。
* AC-010: アクセシビリティ監査で主要フローが WCAG 2.2 AA を満たす。

---

## 14. 運用・モデレーション

* 通報 SLA（初動）: 24時間以内。
* 仮非表示ポリシー: 初回は24時間、再発で72時間、悪質は管理者判断で恒久非表示。
* NGワードの更新: 週次。
* 週課題（小部屋）テンプレ更新: 週1。

---

## 15. アーキテクチャ（推奨）

* **Web**: Next.js 14+（App Router, RSC/Server Actions）+ React 18 + TypeScript。UIはサーバー中心、クライアントは島状。
* **API**: tRPC または Next API Routes（Route Handlers）。必要に応じて Edge Runtime 併用。
* **認証**: Auth.js（NextAuth.js）メール魔法リンク + WebAuthn Passkey。デバイス上限/全端末ログアウト対応。
* **DB**: PostgreSQL + pgvector（Prisma 拡張）。
* **リアルタイム**: WebSocket（Socket.IO / ws）またはマネージド（Pusher/Ably）。
* **ジョブ/スケジュール**: Vercel Cron/Queues、Cloudflare Queues、または BullMQ（Redis）。
* **検索**: PostgreSQL（全文）→ 将来 Meilisearch/OpenSearch。
* **CDN/画像**: Vercel / Cloudflare Images 等。
* **メール**: Resend/SendGrid（魔法リンク）。
* **監視**: Vercel Analytics + Sentry + OpenTelemetry/APM。
* **インフラ**: Vercel（MVP）/ Fly.io / Render（代替）。

---

## 16. リスクと対策

* **匿名の荒れ**: スローモード/スレ分割/承認制小部屋/通報即仮非表示。
* **著作権/規約**: 音源は持たない・埋め込みを避けリンク誘導・作品単位で規約チェック可能な設計。
* **AI利用の透明性**: 自動リライトはテンプレ提示に留め、公開文はユーザー編集を前提。プロセスノート整備。
* **スケール**: 書き込みはスロットリング、レコメンドはバッチ前計算＋オンライン近傍。
* **離脱**: 儀式スキップ常設、通知は集約。

---

## 17. リリース計画（例）

* **Phase 0**（2–3週）: スキーマ/認証/作品ページ/メモ/スタンプ。
* **Phase 1**（2週）: ラウンジ（スレ/スローモード/通報）。
* **Phase 2**（2週）: 近縁曲/気分検索/簡易相関図。
* **Phase 3**（2週）: 小部屋（承認/期間制）。
* **Phase 4**（継続）: A/B・ダッシュボード・アクセシビリティ強化。

---

## 18. テスト観点（抜粋）

* 認証: 魔法リンク・Passkey、端末上限、全端末ログアウト。
* メモ: タイマー挙動、要約テンプレ、公開/非公開切替。
* レコメンド: 入力語彙変化に対する候補安定性、重みパラメータのAB評価。
* コミュニティ: スローモード制御、ブロック/ミュート、通報→仮非表示→復帰。
* 規約: DBに外部曲IDが残らないことの監査。

---

## 19. 将来拡張

* 作品別「写経ノート」（ベン・フランクリン方式: 要点→自分の言葉→比較）。
* 集中モード（70dB相当環境音のガイド、2分聴いて2分書くサイクル）。
* 共有カード生成（共鳴スコア/タグを画像化）。
* 語彙学習による**個人モデル**最適化（パーソナライズ）。

---

### 付録A: タグ体系（初期案）

* **時代**: 中世/ルネサンス/バロック/古典/ロマン/近代。
* **形式**: ミサ/モテット/フーガ/ソナタ/交響曲/室内楽/受難曲/協奏曲 など。
* **調性**: 長調/短調 + 主音（C, G, D...）。
* **編成**: 独奏/室内/管弦/合唱/オルガン/鍵盤 等。
* **テンポ感**: 緩/中/速（将来 BPM レンジ）。
* **曲想（キュレーション）**: 荘厳/神秘/透明/焦燥/祈り/遊戯性/厳粛 など。
* **感情（ユーザー語彙）**: 自由語彙 + 正規化辞書（同義語束ね）。

---

### 付録B: 例示 UI 文言

* ログイン成功: 「開演です」
* ログアウト: 「本日の終演」
* 禁止行為検知: 「猫様の爪が光りました（一定時間投稿制限）」

---

> 本要件は、規約回避・安全運用・学習体験の3点を**MVPで両立**することを最優先とする。以降の詳細化は、画面フロー図・ER 図・イベントトラッキング定義に順次分解する。
